---
title: "05_overlapping_Granges"
author: "JR"
date: "7/26/2022"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = F)
library(GenomicRanges)
library(tidyverse)
# library(Gviz)
library(IRanges)

```


# digging deeper into @to adn @from
Let's dig into what information results from findOverlaps

```{R 10K peaks have 13K overlaps}

# let's determine the length of our pol2_chip Grange (number of peaks)
length(pol2_chip)
# 10,255 peaks 


# Number of peaks that overlap promoters
length(table(promoter_overlaps@from))


table(table(promoter_overlaps@to))
#  1     2     3 
# 12831   464     4 

# Thus, 13,771 = 12,831 + 2*464(=928) + 3*4(=12) -> 13,771
# or 12,831 + 928 + 12 = 13,771

### How many of these are unique:
# 12,831 + 464 + 4 = 13,299
# We will come back to this

```

# Different dataframe persepective on overlaps
```{R accounting oerlaps in @to and @from}

# Let's look at all the peak overlaps (13,771) in two different data frames:
# Data frame from peak perspective (@from)
overlapping_pol2 <- pol2_chip[promoter_overlaps_df$pol2_index] %>% 
  as.data.frame()

# Data frame from promoter perspective (@to)
overlapping_promoters <- gencode_promoters[promoter_overlaps_df$promoter_index] %>% 
  as.data.frame()
# note most promoters are unique
# >> Note both are 13,771 long

# Now let's merge these two data frames (they both have the same gene_id)
# We are using the promoter_overlaps_df we made above as it's the same as
# overlapping_pol2

promoter_overlaps_df$promoter_gene_id <- overlapping_promoters$gene_id
promoter_overlaps_df
# Look in env

# adding more data to the same data frame (gene_name & peak_name)
# adding gene_name
promoter_overlaps_df$promoter_gene_name <- overlapping_promoters$gene_name

# adding pol2 chip-peak name
promoter_overlaps_df$peak_name <- overlapping_pol2$name

# How many promoters had overlaps:
length(unique(promoter_overlaps_df$promoter_gene_id))
# Chip-peaks overlapped 13,299 promoters.

# Now lets find the length of "unique" pol2 chip-peaks
length(unique(promoter_overlaps_df$peak_name))
# We can see 7,738 peaks were in the overlaps
# Thus ~2K were not overlapping promoters (10K chip peaks total)

# IN CONCLUSION:

# 7,738 of 10,255 Pol2 ChiP-peaks observed overlapped 13,299 promoters.

# Thus, it is important to know how overlaps work to be sure you have the
# correct numbers !

```

Let's bring this all back together.

10,255 chip-peaks were observed
7,738 of these peaks overlapped  13,771 promoter overlaps (@from)
13,771 promoters had overlaps (@to)
13,299 unique promoters had overlaps (@to)


So 7,738 overlapping peaks resulted in 13,771 overlaps with promoters which represented 13,299 unique promoters.



*********************
EXCERCISE
*********************

Find overlaps with promoters of group proteins.

What happens if we shrink the promoter windows? Some standards are 2Kb upstream 1kb down stream. 
Some could be as small as 1Kb upstream 500Kb downstream. Try two different promter window sizes and record
@from and @to values as well as unique peaks. 
