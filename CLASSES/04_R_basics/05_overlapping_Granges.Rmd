---
title: "05_overlapping_Granges"
author: "JR"
date: "7/26/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = F)
library(GenomicRanges)
library(tidyverse)
# library(Gviz)
library(IRanges)

```

# genome features overlapping chip data
Now let's use GRanges to find overlaps of genome features and peaks from ChIPseq.
This is probably one of the most commonly used functions in genome sciences!
First we need to import POLR2A Chip-seq files -- a simple .bed file of peaks.

```{r reading in Pol2 peaks}

# setting file path to peak files

basepath <- "/scratch/Shares/rinnclass/CLASS_2023/<your_folder>"
path <- "CLASS_2023/CLASSES/03_Nextflow/00_Pol2_NF_CORE_RUN/results/bwa/mergedLibrary/macs/broadPeak"

# first we read the peak files in as gRanges object with rtracklayer function.
peaks1 <- rtracklayer::import(file.path(basepath,path, "POLR2A_R1_peaks.broadPeak"))
peaks2 <- rtracklayer::import(file.path(basepath,path, "POLR2A_R2_peaks.broadPeak"))

# Load Gencode-v32: for genome features.
gencode_gr <- rtracklayer::import("/scratch/Shares/rinnclass/CLASS_2023/data/data/genomes/gencode.v32.annotation.gtf")

```

# promoters function
Now let's define the promoters using the handy promoters function in GRanges

```{R promoters}

# The promoter functions will use the first base in a genbody at the TSS.
# Then we can define the promoter up and downstream from there.
?promoters

# let's add 1Kb upstream and downstream from the TSS to define "promoters"
gencode_promoters <- promoters(gencode_gr[gencode_gr$type == "gene"], 
                               upstream = 1e3, 
                               downstream = 1e3)


length(gencode_promoters)
# there are ~60,000 promoters in the $type == gene

```

# findOVerlaps function
Now we have promoter ranges and peak ranges let's use findOverlaps function

```{R findoverlaps chip peaks &}
# Promoter overlap function requires two parameters:
# Query file (peaks) and subject file (promoters)
promoter_overlaps_pol2_peaks1 <- findOverlaps(peaks1, gencode_promoters)
promoter_overlaps_pol2_peaks1

# nice we see that 19,063 promoters overlap with Pol2 replicate 1.
# Let's try the same for replicate 2:

promoter_overlaps_pol2_peaks2 <- findOverlaps(peaks2, gencode_promoters)
promoter_overlaps_pol2_peaks2

# 19,700 promoters overlap -- so similar to rep 1.
```

This raises the question: Are these the same promoters?
We can use our new skill and findOverlaps of the overlaps :)

# Overlap of promoters between replicates

```{r overlap of overlaps}
# one obvious thought maybe to do findOverlaps(promoter_overlaps_pol2_peaks1, promoter_overlaps_pol2_peaks2)
# Let's try it !

same_prom_ov <- findOverlaps(promoter_overlaps_pol2_peaks1, promoter_overlaps_pol2_peaks2)

# huh that didn't work? Why not?
```
well the findOveralps provides @to and @from that can's be overlapped 
these are indicies of which one overlaps
Peak 1 w. Peak 7, Peak 1 with peak 10 etc ...
NOTE: each peak is going to have numerous overlaps so we want only the unique ones.

# indexing into an overlaps file and then finding overlaps.

```{r overlap of overlaps}
# We have all the info we need in peaks1 and 2.
# Thus we can index there and only retreive the peaks that had overlaps
# Since we did peaks1, gencode promoters peaks1 is @ from adn promoters @ to

# indexing
peak1_ov_gr <- peaks1[unique(promoter_overlaps_pol2_peaks1@from)] 

# indexing
peak2_ov_gr <- peaks2[unique(promoter_overlaps_pol2_peaks2@from)]

# now let's find the overlaps of the overlaps
ov_of_ov <- findOverlaps(peak1_ov_gr, peak2_ov_gr)
ov_of_ov

# nice we see that there are 12,961 promoter overlaps in common.
# 13,857 and 14,403 promoter ov had 12,961 in common ~90% !
```

So the good news is we have good overlap but that was kinda 
annoying to have to index before the second overlaps.

Luckily someone thought of that too and made a function called:
subsetbyoverlaps!

This will retrieve the overlapping index only from the original Granges.


# Using subseByOverlaps instead of findOverlaps

```{r SubsetByOverlaps }

# subset overlaps from peaks1 and promoters
promoter_overlaps_pol2_peaks1 <- subsetByOverlaps(peaks1, gencode_promoters)
promoter_overlaps_pol2_peaks1
# 13,857 = same as before with findOverlaps

# subset overlaps from peaks2 and promoters
promoter_overlaps_pol2_peaks2 <- subsetByOverlaps(peaks2, gencode_promoters)
promoter_overlaps_pol2_peaks2
# 14,403 = same as before with findOverlaps

# now overlapping the two overlaps by findOverlaps
subset_overlaps_peaks <- findOverlaps(promoter_overlaps_pol2_peaks1, promoter_overlaps_pol2_peaks2)
subset_overlaps_peaks
# 12,961 -- It's the same -- yay and simpler code.

```

This is great that findOverlaps + indexing = subsetByOverlaps 
However, remember how we had more overlaps than peaks in R_basics/03 ???

Let's see if perhaps this is more overlaps than peaks !

# how many unique peaks resulted in 12,961 overlaps
```{r how many unique peaks had overlaps}

# we can use length and unique to solve this
length(unique(subset_overlaps_peaks@to))
length(unique(subset_overlaps_peaks@to))
# Yup there were only 12,257 peaks that had 12,961 overlaps!


# let's use our lessons from R_basics/03 to find out:
table(table(subset_overlaps_peaks@from))

#1     2     3     4 
# 11589   633    34     1 

# This means there are = 12,961 overlaps and unique = from 12,257 peaks
# note we did this for @from (promoter_overlaps_pol2_peaks1)
# let's look at @to
table(table(subset_overlaps_peaks@to))

#  1     2     3     4 
# 12037   413    30     2 

# This also adds up to 12,961 with
# 12,482 unique peaks

```

Nice so we are getting really good at overlaps in GenomicRanges!
Abover we took the approach of overlap each peak file to promoters
then overlapping those overlaps.

Alternatively we can find overlaps of the peak files and then
overlaps with promoters. 

Let's try overlapping peaks first then promoters:

# peak overlaps realtive to promoters

```{r peak overlaps and promoter overlaps}

pol2_consensus_peaks <- subsetByOverlaps(peaks1, peaks2)
pol2_consensus_peaks
# 27,206 
peaks1
# 33,582
peaks2
# 43,435

# Ok so we somethign similar to R_basica/03_

# Overlap with promoters:
pol2_consensus_peaks_ov_promoters <- subsetByOverlaps(pol2_consensus_peaks, gencode_promoters)
pol2_consensus_peaks_ov_promoters
# 12,331
```

cool so we saw before that it was 12,961 promoter overlaps 
now we have 12,331 which is pretty close 

# Do we dare to compare the promters ov from both methods?
# Go on then :)

```{r promoter overlaps between methods}

# so we previously made overlaps this way (changed to subsetByOverlaps)

subset_overlaps_peaks <- subsetByOverlaps(promoter_overlaps_pol2_peaks1, promoter_overlaps_pol2_peaks2)
subset_overlaps_peaks
# 12,257 unique overlap


# let's overlap this with peak overlaps

both_method_ov <- subsetByOverlaps(subset_overlaps_peaks, pol2_consensus_peaks_ov_promoters )
both_method_ov
# 12,257 that is a good sign that we got the same result !

# The one downside is we can't see how this all worked with @to and @from
both_method_ov@from 
#error :( 

```

Ok, that was a lot of overlapping. To summarize:
1) FindOverlaps will keep the @from and @to information 
2) Subset by overlaps only keeps the ranges that overlap 
3) you can do the same by indexing the original query or subject file
e.g. peaks1[unique(promoter_overlaps_pol2_peaks1@from)] 
4) Subset by overlaps is great for continuing to do lots of overlaps
5) @from = subject, @to = query


#########################
Excercise 
#########################

1) Find the peaks that overlap in all the replicates of your favorite protein.
- make sure to document how many peaks were in each starting file for overlaps
- how did this number change

2) How many of those peaks overlap promoters? 
- how many unqiue peaks are there that resulted in N overlaps?

