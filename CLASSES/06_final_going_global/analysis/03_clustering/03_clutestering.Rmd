---
title: "03_clustering"
author: "JR"
date: "8/15/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = F)
library(tidyverse)
library(GenomicRanges)
library(ggplot2)
library(pheatmap)
library(ComplexHeatmap)
source("../../util/my_class_functions.R")
source("../../util/_setup.R")
install.packages("colorRamps")

```

# loading in peak_features env objects from 01_create_consensus_peaks
```{r laod env objects}

load("../01_create_consensus_peaks/results/peak_features.RData", verbose = T)

```

# creating distance matrix & dendrogram
```{r distance matrix and dendrogram}

# creating distance matrix
peak_occurence_dist <- dist(promoter_peak_matrix, method = "binary")

# clustering distance values
bin_hier <- hclust(peak_occurence_dist, method = "complete")

# Dendrogram of binding profiles by promoter (not binding profile - below)
ggdendro::ggdendrogram(bin_hier, rotate = FALSE,  size = 3,
                       theme_dendro = TRUE) +
   coord_flip() +
   scale_y_continuous() +
   scale_x_continuous(position = "top") +
   scale_x_continuous(breaks = seq_along(bin_hier$labels[bin_hier$order]),
             labels = bin_hier$labels[bin_hier$order], position = "top",
             expand = c(0,0)) +
   theme(axis.text.x = element_text(angle = 90, hjust  = 1)) +
   theme(axis.text.y = element_text(angle = 0,hjust = 1)) +
   scale_y_reverse(expand = c(0.01, 0)) +
   theme(
     plot.background = element_blank(),
     panel.grid.major = element_blank(),
   panel.grid.minor = element_blank(),
     panel.border = element_blank()
   )

```

# start point for metaplots and clustering
```{r}
load("../../../05_R_analyses/01_peak_features/results/peak_features.RData", verbose = T)
```

# Using profile_tss for all 430 DBPs
```{r metaplot DF of binding profiles over promoter}

# establishing DF
metaplot_df <- data.frame(x = integer(), dens = numeric(), dbp = character())

# for loop to populate DF 
for(i in 1:length(filtered_consensus_list)) {
  print(names(filtered_consensus_list)[[i]])
  tmp_df <- profile_tss(filtered_consensus_list[[i]], lncrna_mrna_promoters)
  tmp_df$dbp <- names(filtered_consensus_list)[[i]]
  metaplot_df <- bind_rows(metaplot_df, tmp_df)
  
}

# saving
write_rds(metaplot_df, "results/metaplot_df_final.rds")

```
  

# creating distance matrix of binding profile correlations
```{r scaling and plotting dendrogram of binding similarity by promoter}

metaplot_filtered_matrix <- metaplot_df %>% 
  pivot_wider(names_from = x, values_from = dens) %>%
  column_to_rownames("dbp") %>%
  as.matrix()
mm_scaled <- t(scale(t(metaplot_filtered_matrix)))
metaplot_hclust <- hclust(dist(mm_scaled), method = "complete")

# plotting relationship between binding profiles
plot(metaplot_hclust)
pdf("figures/tss_profile_dendrogram.pdf", height = 10, width = 27)
par(cex=0.3)
plot(metaplot_hclust)
dev.off()
```

# heat map of binding profile over +/- 1kb TSS window
```{r heatmap of profile over TSS (+/- 1Kb)}

# setting up PDF function for saving
pdf("figures/tss_profile_heatmap.pdf", height = 35, width = 10)

# complex heatmap of mm_scaled
Heatmap(mm_scaled, cluster_columns = FALSE, col = col_fun, border = TRUE, 
        show_column_names = FALSE,
        use_raster = TRUE,
        column_split = split,
        column_gap = unit(0, "mm"),row_names_gp = gpar(fontsize = 7))
# to save
dev.off()
```

# looking more into the patterns of ChIP binding profiles relative to TSS
```{r how many groups are there?}

# Let's see how many DBPs have different patterns.
clusters <- cutree(metaplot_hclust, k=4)
table(clusters)

# plot cluter 1

pdf("figures/cluster_1_heatmap.pdf", height = 35, width = 10)

Heatmap(mm_scaled[clusters == 4,], cluster_columns = FALSE, col = col_fun, border = TRUE, 
        show_column_names = FALSE,
        use_raster = TRUE,
        column_split = split,
        column_gap = unit(0, "mm"),row_names_gp = gpar(fontsize = 7))

dev.off

```


